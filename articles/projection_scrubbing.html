<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Projection scrubbing for outlier detection in high-dimensional data with `fMRIscrub` • fMRIscrub</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Projection scrubbing for outlier detection in high-dimensional data with `fMRIscrub`">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fMRIscrub</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.13.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/projection_scrubbing.html">Projection scrubbing for outlier detection in high-dimensional data with `fMRIscrub`</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mandymejia/fMRIscrub/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Projection scrubbing for outlier detection in
high-dimensional data with <code>fMRIscrub</code>
</h1>
                        <h4 data-toc-skip class="author">Amanda Mejia,
Preya Shah &amp; Damon Pham</h4>
            
            <h4 data-toc-skip class="date">2025-07-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mandymejia/fMRIscrub/blob/0.13.0.s/vignettes/projection_scrubbing.rmd" class="external-link"><code>vignettes/projection_scrubbing.rmd</code></a></small>
      <div class="hidden name"><code>projection_scrubbing.rmd</code></div>

    </div>

    
    
<p><code>fMRIscrub</code> is an R package that implements routines for
scrubbing fMRI data, namely projection scrubbing, DVARS, and motion
scrubbing with framewise displacement. Projection scrubbing is also
applicable to other high-dimensional outlier detection tasks.</p>
<p>In this vignette we will highlight the use of projection scrubbing
for identifying and removing contaminated volumes from fMRI scans.
Projection scrubbing works by identifying component directions in the
data likely to represent transient artifacts, and then computing a
composite measure for the amount of these signals at each volume. The
projection can be PCA or ICA, and the composite measure is based on the
linear model concept of leverage. (An earlier version of projection
scrubbing was named “PCA leverage”). Like other scrubbing methods, it is
designed to detect burst noise caused by artifact sources such as
subject head motion. Projection scrubbing can be cited with the
following papers:</p>
<ul>
<li>Mejia, A. F., Nebel, M. B., Eloyan, A., Caffo, B. &amp; Lindquist,
M. A. PCA leverage: outlier detection for high-dimensional functional
magnetic resonance imaging data. Biostatistics 18, 521–536 (2017).</li>
<li>Pham, D., McDonald, D., Ding, L., Nebel, M. B., &amp; Mejia, A. Less
is more: balancing noise reduction and data retention in fMRI with
data-driven scrubbing. NeuroImage, 119972 (2023).</li>
</ul>
<div class="section level4">
<h4 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h4>
<p>Install the package from CRAN and load it:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("fMRIscrub)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mandymejia/fMRIscrub" class="external-link">fMRIscrub</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="tutorial">Tutorial<a class="anchor" aria-label="anchor" href="#tutorial"></a>
</h2>
<div class="section level4">
<h4 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h4>
<p><code>fMRIscrub</code> includes resting-state scans from two subjects
in the Autism and Brain Imaging Data Exchange (ABIDE), a publicly
available neuroimaging resource <a href="https://doi.org/10.1038/mp.2013.78" class="external-link">(Di Martino and others,
2014)</a>. The first scan contains several artifacts likely due periods
of high subject head motion; the second has few visible artifacts. The
data represent axial slices instead of the entire brain to minimize the
package size of <code>fMRIscrub</code>.</p>
</div>
<div class="section level4">
<h4 id="results">Results<a class="anchor" aria-label="anchor" href="#results"></a>
</h4>
<p>The data for both subjects consist of a sagittal slice from an fMRI
volume. The fMRI data was preprocessed with pre-processed with slice
time correction, rigid body realignment estimation, spatial
normalization to MNI space, and linear detrending. A brain mask has been
applied to vectorize the data, forming a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>×</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">T \times V</annotation></semantics></math>
(time by voxel) matrix. These are automatically added into the
environment upon loading <code>fMRIscrub</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">Dat1</span><span class="op">)</span> <span class="co"># subject 0050048 (Pitt); many artifacts</span></span></code></pre></div>
<pre><code><span><span class="co">## [1]  193 4675</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">Dat2</span><span class="op">)</span> <span class="co"># subject 0051479 (Caltech); few or no artifacts</span></span></code></pre></div>
<pre><code><span><span class="co">## [1]  145 4679</span></span></code></pre>
<p>We will now run projection scrubbing on both datasets. We’ll use the
default implementation (ICA leverage), except additionally we will
stabilize each component’s mean and variance prior to kurtosis and
leverage computation.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ps.Dat1</span> <span class="op">=</span> <span class="fu"><a href="../reference/pscrub.html">pscrub</a></span><span class="op">(</span><span class="va">Dat1</span>, verbose<span class="op">=</span><span class="cn">TRUE</span>, comps_mean_dt<span class="op">=</span><span class="fl">1</span>, comps_var_dt<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Checking for missing, infinite, and constant data.</span></span></code></pre>
<pre><code><span><span class="co">## Warning in pscrub_multi(X = X, projection = projection, nuisance = nuisance, : Removing 283 constant data columns (out of 4675).</span></span></code></pre>
<pre><code><span><span class="co">## Performing nuisance regression.</span></span>
<span><span class="co">## Centering and scaling the data columns.</span></span>
<span><span class="co">## Computing PESEL.</span></span>
<span><span class="co">## Computing ICA.</span></span>
<span><span class="co">## Computing leverage.</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># same as: scrub(Dat1, verbose=TRUE, comps_mean_dt=1, comps_var_dt=1)</span></span>
<span><span class="va">ps.Dat2</span> <span class="op">=</span> <span class="fu"><a href="../reference/pscrub.html">pscrub</a></span><span class="op">(</span><span class="va">Dat2</span>, verbose<span class="op">=</span><span class="cn">TRUE</span>, comps_mean_dt<span class="op">=</span><span class="fl">1</span>, comps_var_dt<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Checking for missing, infinite, and constant data.</span></span></code></pre>
<pre><code><span><span class="co">## Warning in pscrub_multi(X = X, projection = projection, nuisance = nuisance, : Removing 68 constant data columns (out of 4679).</span></span></code></pre>
<pre><code><span><span class="co">## Performing nuisance regression.</span></span>
<span><span class="co">## Centering and scaling the data columns.</span></span>
<span><span class="co">## Computing PESEL.</span></span>
<span><span class="co">## Computing ICA.</span></span>
<span><span class="co">## Computing leverage.</span></span></code></pre>
<p>Let’s take a look at the leverage timeseries for both scans with
<code>plot</code>. The flagged timepoints are highlighted by the grey
bars.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ps.Dat1</span>, title<span class="op">=</span><span class="st">"Dat1"</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ps.Dat2</span>, title<span class="op">=</span><span class="st">"Dat2"</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="projection_scrubbing_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<p>ICA leverage indicates clear outliers in the first dataset around the
60th and 150th timepoints. while the second dataset is relatively
artifact-free, a few timepoints are still flagged including around the
40th and 110th timepoints. Note that the suspected artifacts in the
first dataset have significantly greater leverage than the suspected
artifacts in the second dataset.</p>
<p>DVARS, another data-driven scrubbing technique <a href="https://doi.org/10.1016/j.neuroimage.2017.12.098" class="external-link">(Afyouni and
Nichols, 2018)</a>, yields similar results:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/DVARS.html">DVARS</a></span><span class="op">(</span><span class="va">Dat1</span><span class="op">)</span>, title<span class="op">=</span><span class="st">"Dat1"</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># same as: plot(scrub(Dat1, "DVARS"), title="Dat1", show.legend=FALSE)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/DVARS.html">DVARS</a></span><span class="op">(</span><span class="va">Dat2</span><span class="op">)</span>, title<span class="op">=</span><span class="st">"Dat2"</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="projection_scrubbing_files/figure-html/unnamed-chunk-6-1.png" width="768"></p>
</div>
<div class="section level4">
<h4 id="fmri-image-reconstruction">fMRI image reconstruction<a class="anchor" aria-label="anchor" href="#fmri-image-reconstruction"></a>
</h4>
<p>Let’s see what the problem was in the first scan. We can reconstruct
the original fMRI image using the mask which was originally applied to
vectorize it.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Unmask the first scan</span></span>
<span><span class="va">fname</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Dat1_mask.nii.gz"</span>, package <span class="op">=</span> <span class="st">"fMRIscrub"</span><span class="op">)</span></span>
<span><span class="va">Mask1</span> <span class="op">=</span> <span class="fu">readNIfTI</span><span class="op">(</span><span class="va">fname</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="co">#Pitt_0050048 (full of artifacts)</span></span>
<span><span class="va">Mask1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">Mask1</span>, dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">Mask1</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="co"># 2D --&gt; 3D slice</span></span>
<span><span class="va">Img1</span> <span class="op">=</span> <span class="fu">fMRItools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fMRItools/man/unvec_vol.html" class="external-link">unvec_vol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Dat1</span><span class="op">)</span>, <span class="va">Mask1</span><span class="op">)</span></span></code></pre></div>
<p>We will compare the timepoint of median leverage (left) to the
timepoint of maximum leverage (right).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mfrow_original</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="st">"mfrow"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">levs</span> <span class="op">=</span> <span class="va">ps.Dat1</span><span class="op">$</span><span class="va">measure</span></span>
<span><span class="va">t_med</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">levs</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">levs</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">t_max</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">levs</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">Img1</span><span class="op">[</span>,,,<span class="va">t_med</span><span class="op">]</span>, main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Median lev (T = '</span>, <span class="va">t_med</span>, <span class="st">')'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">Img1</span><span class="op">[</span>,,,<span class="va">t_max</span><span class="op">]</span>, main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Maximum lev (T = '</span>, <span class="va">t_max</span>, <span class="st">')'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="projection_scrubbing_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>The median time point appears normal, whereas the most outlying time
point clearly has banding artifacts likely due to subject motion.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="va">mfrow_original</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="artifact-images">Artifact images<a class="anchor" aria-label="anchor" href="#artifact-images"></a>
</h4>
<p><code>fMRIscrub</code> can also display the “artifact images” for
each outlying observation. These are based on the projection directions
for the selected components. There are two types of artifact images: the
composite of the selected directions, weighed by the variance-normalized
scores for that timepoint, and the single direction with the strongest
signal at that timepoint. Here are the artifact images at 60 for the
first dataset:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">psx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pscrub.html">pscrub</a></span><span class="op">(</span><span class="va">Dat1</span>, projection<span class="op">=</span><span class="st">"ICA"</span>, get_dirs<span class="op">=</span><span class="cn">TRUE</span>, comps_mean_dt<span class="op">=</span><span class="fl">1</span>, comps_var_dt<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in pscrub_multi(X = X, projection = projection, nuisance = nuisance, : Removing 283 constant data columns (out of 4675).</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">artImg1</span> <span class="op">=</span> <span class="fu"><a href="../reference/artifact_images.html">artifact_images</a></span><span class="op">(</span><span class="va">psx</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Constant voxels are deleted during the `pscrub` algorithm, so the artifact images will have</span></span>
<span><span class="co"># missing values where the constant voxels were. </span></span>
<span><span class="va">artImg1.mean</span> <span class="op">=</span> <span class="fu">fMRItools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fMRItools/man/unvec_vol.html" class="external-link">unvec_vol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">artImg1</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span>, <span class="va">Mask1</span><span class="op">)</span></span>
<span><span class="va">artImg1.top</span> <span class="op">=</span> <span class="fu">fMRItools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fMRItools/man/unvec_vol.html" class="external-link">unvec_vol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">artImg1</span><span class="op">$</span><span class="va">top</span><span class="op">)</span>, <span class="va">Mask1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">psx</span><span class="op">$</span><span class="va">outlier_flag</span><span class="op">)</span> <span class="op">==</span> <span class="va">t_max</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">artImg1.mean</span><span class="op">[</span>,,<span class="fl">1</span>,<span class="va">idx</span><span class="op">]</span>, main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Lev image, mean (T='</span>,<span class="va">t_max</span>,<span class="st">')'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">artImg1.top</span><span class="op">[</span>,,<span class="fl">1</span>,<span class="va">idx</span><span class="op">]</span>, main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Lev image, top (T='</span>,<span class="va">t_max</span>,<span class="st">')'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="projection_scrubbing_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>The artifact images highlight the banding artifact present at this
time point.</p>
</div>
</div>
<div class="section level2">
<h2 id="appendix">Appendix<a class="anchor" aria-label="anchor" href="#appendix"></a>
</h2>
<div class="section level4">
<h4 id="more-information-about-projection-scrubbing">More information about projection scrubbing<a class="anchor" aria-label="anchor" href="#more-information-about-projection-scrubbing"></a>
</h4>
<p>As input, <code>pscrub</code> takes a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
x
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>
matrix,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>.
In our case,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>
represents an fMRI run: each row is a vectorized volume, and each column
represents the timeseries of a single data location. Next, the algorithm
performs the following steps:</p>
<ol style="list-style-type: decimal">
<li><p>Perform a nuisance regression with four discrete cosine transform
(DCT) bases to remove low-frequency trends in the data. This helps the
data projection method better identify artifactual components. (More or
less nuisance regressors can be specified with the <code>nuisance</code>
argument.)</p></li>
<li><p>Normalize
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>
by centering and scaling its columns robustly. (This can be disabled
with the <code>center</code> and <code>scale</code> arguments.)</p></li>
<li><p>Decompose the data into
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>
components, each consisting of a length
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>
projection direction and a length
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
signal timecourse, using PCA or ICA. The projection directions are the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>
matrix in PCA
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mi>U</mi><mi>D</mi><mi>V</mi><mi>′</mi></mrow><annotation encoding="application/x-tex">Y = UDV'</annotation></semantics></math>),
and the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>M</mi><annotation encoding="application/x-tex">M</annotation></semantics></math>
matrix in ICA
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mi>M</mi><mi>S</mi></mrow><annotation encoding="application/x-tex">Y = MS</annotation></semantics></math>).
The signal timecourses are the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>U</mi><annotation encoding="application/x-tex">U</annotation></semantics></math>
matrix in PCA, and the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
matrix in ICA. By default, ICA projection is used, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>
is determined by the “PESEL” algorithm <a href="https://www.tandfonline.com/doi/abs/10.1080/10618600.2017.1340302" class="external-link">(Sobczyk
and others, 2017)</a>. (This can be changed with the
<code>projection</code> and <code>PESEL</code> arguments. Also,
<code>comps_mean_dt</code> and <code>comps_var_dt</code> can be used to
detrend the means and variances of the component timecourses after
estimation, which is disabled by default.)</p></li>
<li><p>Select
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>&lt;</mo><mi>Q</mi></mrow><annotation encoding="application/x-tex">K &lt; Q</annotation></semantics></math>
of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>
components which are likely to contain artifact information. By default,
we select high-kurtosis components, since burst noise tends to manifest
as transient deviations of much greater magnitude than would be expected
of neuronal signals. (Use <code>kurt_quantile</code> to change or
disable the kurtosis cutoff.)</p></li>
<li><p>Measure leverage across the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics></math>
components. If
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>
is the matrix of selected components, then leverage is the diagonal of
the hat matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>C</mi><mi>′</mi><mi>C</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><mi>C</mi><mi>′</mi></mrow><annotation encoding="application/x-tex">C(C'C)^{-1}C'</annotation></semantics></math>.
The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
leverage values are interpreted as a measure of outlyingness at each
timepoint. Note that if the components are orthogonal and have a 2-norm
of 1 as in PCA, then leverage simplifies to the sum of squared component
values at each timepoint.</p></li>
<li><p>Leverage is thresholded to obtain the set of identified outliers.
By default, timepoints with leverage greater than three times the median
are flagged as outliers. (Use <code>cutoff</code> to change the
threshold.)</p></li>
</ol>
</div>
<div class="section level4">
<h4 id="running-multiple-versions-of-projection-scrubbing-at-a-time">Running multiple versions of projection scrubbing at a time<a class="anchor" aria-label="anchor" href="#running-multiple-versions-of-projection-scrubbing-at-a-time"></a>
</h4>
<p>For testing purposes, we can try different projections at the same
time using the internal function <code>pscrub_multi</code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Try all projections: this is excessive to plot</span></span>
<span><span class="co"># ps.Dat1All &lt;- fMRIscrub:::pscrub_multi(</span></span>
<span><span class="co">#   Dat1, projection="all", verbose=TRUE, comps_mean_dt=1, comps_var_dt=1</span></span>
<span><span class="co"># )</span></span>
<span></span>
<span><span class="co">#  the default (ICA + kurtosis), PCA + kurtosis, and ICA</span></span>
<span><span class="va">ps.Dat1.3</span> <span class="op">&lt;-</span> <span class="fu">fMRIscrub</span><span class="fu">:::</span><span class="fu"><a href="../reference/pscrub_multi.html">pscrub_multi</a></span><span class="op">(</span></span>
<span>  <span class="va">Dat1</span>, projection<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"ICA_kurt"</span>, </span>
<span>    <span class="st">"ICA"</span></span>
<span>  <span class="op">)</span>, verbose<span class="op">=</span><span class="cn">TRUE</span>, comps_mean_dt<span class="op">=</span><span class="fl">1</span>, comps_var_dt<span class="op">=</span><span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Checking for missing, infinite, and constant data.</span></span></code></pre>
<pre><code><span><span class="co">## Warning in fMRIscrub:::pscrub_multi(Dat1, projection = c("ICA_kurt", "ICA"), : Removing 283 constant data columns (out of 4675).</span></span></code></pre>
<pre><code><span><span class="co">## Performing nuisance regression.</span></span>
<span><span class="co">## Centering and scaling the data columns.</span></span>
<span><span class="co">## Computing PESEL.</span></span>
<span><span class="co">## Computing ICA.</span></span>
<span><span class="co">## Computing leverage.</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fMRIscrub</span><span class="fu">:::</span><span class="fu"><a href="../reference/plot.scrub_projection_multi.html">plot.scrub_projection_multi</a></span><span class="op">(</span><span class="va">ps.Dat1.3</span>, legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="projection_scrubbing_files/figure-html/unnamed-chunk-11-1.png" width="576"></p>
</div>
</div>
<div class="footnotes footnotes-end-of-document">
<hr>
<ol>
<li id="fn1"><p>Although the data will be mean-detrended during the
nuisance regression with DCT bases, some trends may persist in the
components because that nuisance regression is estimated non-robustly. A
robust nuisance regression would take too much time to estimate at every
data location. But since
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>&lt;</mo><mo>&lt;</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">Q &lt;&lt; V</annotation></semantics></math>,
we can implement a robust nuisance regression for component detrending.
Still, component detrending is disabled by default because more rigorous
detrending of the original data, such as with anatomical CompCor, seem
to reduce long-term trends in the components, even if estimated
non-robustly. Since the CSF and white matter data are unavailable for
these scans, we use component detrending instead of anatomical
CompCor.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Amanda Mejia, John Muschelli, Damon Pham.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
